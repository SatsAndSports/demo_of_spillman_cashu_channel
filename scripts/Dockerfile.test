# CDK Spilman Channel Tests
#
# Build:
#   git archive HEAD | docker build -f scripts/Dockerfile.test -t cdk-test -
#
# Run:
#   ./scripts/docker-test.sh [cdk|nutmix|all]
#
# Uses cargo-chef for efficient Rust dependency caching.
# Only rebuilds dependencies when Cargo.toml/Cargo.lock change.

# ============================================================
# Stage 1: Base image with system deps + Rust + cargo-chef
# ============================================================
FROM debian:bookworm-slim AS chef

ENV DEBIAN_FRONTEND=noninteractive

# System dependencies (excluding Go - installed separately below)
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    libssl-dev \
    curl \
    python3 \
    python3-pip \
    python3-venv \
    docker.io \
    git \
    make \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# Go 1.21 (needed for go-nostr dependency)
RUN curl -LO https://go.dev/dl/go1.21.13.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.21.13.linux-amd64.tar.gz && \
    rm go1.21.13.linux-amd64.tar.gz
ENV PATH="/usr/local/go/bin:${PATH}"

# docker-compose (for NutMix tests)
RUN curl -SL "https://github.com/docker/compose/releases/download/v2.32.4/docker-compose-linux-x86_64" \
    -o /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose

# Rust toolchain
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    --default-toolchain 1.92.0 \
    --component rustfmt,clippy
ENV PATH="/root/.cargo/bin:${PATH}"

# Install cargo-chef for dependency caching
RUN cargo install cargo-chef

WORKDIR /cdk

# ============================================================
# Stage 2: Planner - extract dependency info
# ============================================================
FROM chef AS planner
COPY . .
RUN cargo chef prepare --recipe-path recipe.json

# ============================================================
# Stage 3: Builder - build deps (cached), then build code
# ============================================================
FROM chef AS builder

# Copy recipe and build dependencies (CACHED if Cargo.toml unchanged)
COPY --from=planner /cdk/recipe.json recipe.json
RUN cargo chef cook --recipe-path recipe.json -p cdk-mintd --features fakewallet
RUN cargo chef cook --recipe-path recipe.json -p cdk-spilman-go
RUN cargo chef cook --recipe-path recipe.json -p cdk-spilman-python

# Pre-download Go dependencies for nutmix-setup-units (CACHED if go.mod/go.sum unchanged)
COPY scripts/nutmix-setup-units/go.mod scripts/nutmix-setup-units/go.sum scripts/nutmix-setup-units/
RUN cd scripts/nutmix-setup-units && go mod download

# Copy source and build actual code
COPY . .
RUN cargo build -p cdk-mintd --features fakewallet
RUN cargo build -p cdk-spilman-go

# Set up Python environment
RUN make venv && make python-dev

# Build Go tools
RUN make build-nutmix-setup-units

# Default: run CDK tests
CMD ["make", "test-python-parallel-cdk", "test-go-parallel-cdk"]
