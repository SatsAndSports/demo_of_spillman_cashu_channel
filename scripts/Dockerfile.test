# CDK Spilman Channel Tests
#
# Build:
#   git archive HEAD | docker build -f scripts/Dockerfile.test -t cdk-test -
#
# Run:
#   ./scripts/docker-test.sh [cdk|nutmix|all]

FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

# ============================================================
# Layer 1: System dependencies
# ============================================================
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    libssl-dev \
    curl \
    python3 \
    python3-pip \
    python3-venv \
    golang-go \
    docker.io \
    git \
    make \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# ============================================================
# Layer 2: docker-compose (for NutMix tests)
# ============================================================
RUN curl -SL "https://github.com/docker/compose/releases/download/v2.32.4/docker-compose-linux-x86_64" \
    -o /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose

# ============================================================
# Layer 3: Rust toolchain
# ============================================================
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    --default-toolchain 1.92.0 \
    --component rustfmt,clippy
ENV PATH="/root/.cargo/bin:${PATH}"

# ============================================================
# Layer 4: Copy source and build
# ============================================================
WORKDIR /cdk
COPY . .

# Build CDK mint
RUN cargo build -p cdk-mintd --features fakewallet

# Build Go Rust library
RUN cargo build -p cdk-spilman-go

# Set up Python environment
RUN make venv && make python-dev

# Build Go tools
RUN make build-nutmix-setup-units

# Default: run CDK tests
CMD ["make", "test-python-parallel-cdk", "test-go-parallel-cdk"]
